#!/usr/bin/env bash

COL_BLACK="\033[30m"
COL_RED="\033[31m"
COL_GREEN="\033[32m"
COL_YELLOW="\033[33m"
COL_BLUE="\033[34m"
COL_MAGENTA="\033[35m"
COL_CYAN="\033[36m"
COL_WHITE="\033[37m"
COL_DEFAULT="\033[39m"

# wrap TEXT COLOR
function wrap() {
    local c=""
    case $2 in
        "black")c=${COL_BLACK};;
        "red")c=${COL_RED};;
        "green")c=${COL_GREEN};;
        "yellow")c=${COL_YELLOW};;
        "blue")c=${COL_BLUE};;
        "magenta")c=${COL_MAGENTA};;
        "cyan")c=${COL_CYAN};;
        "white")c=${COL_WHITE};;
        *)c=${COL_DEFAULT};;
    esac
    echo -e "${c}$1${COL_DEFAULT}"
}

# wrap256 TEXT COLOR-ID
function wrap256() {
    echo -e "\033[38;5;$2m$1${COL_DEFAULT}"
}

PRE_PROMPT="\033[0m" # reset all modes
POST_PROMPT="\033[5 q" # cursor steady bar

function promptCommandFn() {
    # return value
    local ret=$?
    if [ $ret -eq 0 ]; then
        PS1_CMD1=$(wrap256 $ret 40) # green
    elif [ $ret -eq 69 ]; then
        PS1_CMD1=$(wrap256 $ret 129) # purple
    elif [ $ret -eq 147 ] || [ $ret -eq 148 ]; then
        PS1_CMD1=$(wrap256 $ret 226) # yellow
    else
        PS1_CMD1=$(wrap256 $ret 196) # red
    fi

    # git branch
    local branch="$(git branch --show-current 2>/dev/null)"
    if [ ${#branch} -gt 0 ]; then
        PS1_CMD2=" $(wrap256 $branch 226)"
    else
        PS1_CMD2=""
    fi

    local timestamp=$(wrap256 $(date +"%T") 49)
    local userHost=$(wrap256 "$(whoami)@$(hostname)" 175)
    local workDir=$(wrap256 ${PWD/*\//} 75)

    echo -en "${PRE_PROMPT}┌[${timestamp} ${userHost} ${workDir} ${PS1_CMD1}${PS1_CMD2}]"
}

PROMPT_COMMAND=promptCommandFn
PS1="\n└> ${POST_PROMPT}"
